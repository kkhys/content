---
title: "Web API の開発時に覚えておくべきこと"
emoji: 🔌
category: Tech
tags: []
status: draft
publishedAt: 2024-06-25
---

最近、仕事ではバックエンド側で API（当ページの文脈では Web API[^1] を指す）を実装し、それをフロントエンド側で利用するという行為をひたすら続けている。

[^1]: HTTP プロトコルを利用してネットワーク越しに呼び出す API

基本的によく使う API のリファレンス（[Stripe API](https://docs.stripe.com/api) や [Shopify Admin API](https://shopify.dev/docs/api/admin) など）や本を参考に API を組み立てている。
しかし、毎回参照するのは非効率的なので自分用に備忘録としてまとめることにした。

今回ベースとなるのはオライリーから出版されている「[Web API: The Good Parts](https://amzn.asia/d/4NNxZX1)」である。
発売日は 2014 年と古いが Web API の性質上、古くなって使えないという箇所はなく、特に違和感なく読み進められる。
基本が網羅されており、名著だと思う。

API は単にインタフェースに過ぎないため、その設計にあまり時間をかけるべきではない、可能な限りビジネスロジックの実装に時間を費やしたいと思っていた。
しかし、最初の設計を誤まると後々その負債が増大していくことを体験したので軽視できない。
このページでは今後そういったことがないように、自戒を込めて書き留めてゆく。

## エンドポイントの設計とリクエストの形式

この章は API を扱う上で基本中の基本となる部分である。
何らかの開発に携わっている人であれば自然に身に付いている知識だと思う。
特に悩まずにこのとおりに実装すれば大抵は問題ない。

### 必要な機能を抽出する

API を設計するにあたり、クライアントアプリケーションの画面とその遷移をまずは考える。
例えば、図にして書き出すと整理しやすい。その際は MECE（漏れなく、ダブりなく）になるようにする。
その図を元に必要な機能を列挙していく。これがエンドポイントの元になる。

### エンドポイントの基本的な設計

エンドポイントを設計するときには覚えやすく、どんな機能をもつ URI なのかがひと目でわかるようにする。
具体的には以下の事項を考慮する。

- 短く入力しやすい URI
- 人間が呼んで理解できる URI
  - 省略形を含まない
  - 国コードなど標準化されたものは例外
- 大文字小文字が混在していない URI
  - 小文字に統一する
- 改造しやすい URI
  - ドキュメントを見なくても推測可能
- サーバ側のアーキテクチャが反映されていない URI
- ルールが統一された URI
  - ex. ID をパスに入れるのかクエリパラメータに入れるのか

### HTTP メソッド

URI とメソッドの関係は、操作するものと操作方法の関係である。
1 つの URI のエンドポイントに異なるメソッドでアクセスすることで、リソースをどう扱うかをきちんと分離できる。
HTML は Form において POST と GET しか使用できない[^2]。
その名残のせいなのか API においても更新・削除で POST を使っているケースがたまに見受けられるが、可能であればそれ以外（以下を参照）も積極的に使用したい。

[^2]: なぜ HTML の Form では POST と GET しか使えないのかについては [こちら](https://blog.jxck.io/entries/2023-11-27/hixie.html) の記事が参考になった。

| メソッド名  | 説明           |
|--------|--------------|
| GET    | リソースの取得      |
| POST   | リソースの新規登録    |
| PUT    | 既存リソースの更新    |
| DELETE | リソースの削除      |
| PATCH  | リソースの一部変更    |
| HEAD   | リソースのメタ情報の取得 |

※ PUT は送信したデータで元々のリソースを置き換えるものであるのに対し、PATCH ではその一部だけを更新したい場合に使用する。

HTML の Form では GET と POST しか使えないが、他にもクライアントによっては HTTP メソッドの利用が制限される場合がある。
その場合は API 側で GET/POST 以外のメソッドを POST を使って表現することを許可できる。

具体的には 2 つの方法がある。
まず 1 つ目は `X-HTTP-Method-Override` という HTTP リクエストヘッダを使う方法、2 つ目は `_method` というパラメータを利用する方法である。

`_method` を使う場合は `application/x-www-form-urlencoded` という Content Type で表されるデータの一部として送信する。
これは Ruby on Rails などが採用している方法である[^3]。
しかし、上記の形式以外ではデータを送信できない（使い方を明確に定義できない）ため、できれば `X-HTTP-Method-Override` を使用する方が良い。
また、リクエストデータの中にデータ以外のメタ情報が入ってしまうのは送信データを分類するという意味においてあまり好ましくない。

[^3]: [Rails ガイドより](https://railsguides.jp/form_helpers.html#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bpatch%E3%83%BBput%E3%83%BBdelete%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%8B%95%E4%BD%9C)

`X-HTTP-Method-Override` を使う場合は以下のように HTTP リクエストヘッダに利用したいメソッドを指定するだけ。

```text
POST /posts HTTP/1.1
Host: example.com
X-HTTP-Method-Override: PUT
```

サーバ側のフレームワークやミドルウェアによっては上記のヘッダを自動的に解釈する場合もあるので有効に使える方法を選択する。

### API のエンドポイント設計

リソースにアクセスするためのエンドポイントを設計する際は以下の点に注意する。

- 複数形の名詞を利用する
  - [こういった考え方](https://twitter.com/ellnore_pad_267/status/1552152179246452737) もあるのでプロジェクトによるかも
- 利用する単語に気をつける
  - ex. `find` ではなく `search` を使う[^4]
- スペースやエンコードを必要とする文字を使わない
  - [パーセントエンコーディング](https://developer.mozilla.org/ja/docs/Glossary/Percent-encoding) された文字が入らないようにする
- 単語をつなげる必要がある場合はハイフンを利用する
  - 絶対という訳ではなく、プロジェクトに準ずる
  - そもそも単語のつなぎ合わせを避ける設計にする

[^4]: find は探すものを目的語にとり、search は探す場所を目的語にとるため

### 検索とクエリパラメータの設計

たくさんあるデータの一部を取得する際にはページネーションの仕組みを利用する。
`page/per_page` や `offset/limit` のようなクエリパラメータを設定するのが一般的。

例えば、数あるアイテムの中から 101 アイテム目から取得したい場合は以下のようにする。

- `per_page=50&page=3`
- `limit=50&offset=100`

`offset/limit` の方が自由度は高いが、要件によってどちらにするかを決める。
ただし、上記のような相対的な取得位置でデータを取得する方法にはパフォーマンス上の懸念がある[^5]。
また、更新頻度の高いデータにおいてデータの不整合が生じるという問題もあるため慎重に導入を決めなければならない。

[^5]: RDB では `offset` と `limit` を使って位置を取得する場合、先頭から数を数えるため行数が多くなればなるほど遅くなる（[参考](https://tech-up.hatenablog.com/entry/2019/04/03/101643)）

絶対位置でデータを取得する場合は相対位置での問題点をカバーできる。
例えば、「この ID よりも前のもの」や「この時刻よりも古いもの」のような指定方法を用いる。

クエリパラメータはその他に、絞り込みのために使用する。
検索するフィールドがほぼ 1 つに決まる場合は `q` というパラメータが使われる場合もある（Google の検索結果など）。

クエリパラメータとパスの使い分けは一意なリソースを表すのに必要な情報かどうかで判断する。
これは URI がリソースを表すものであるという URI の思想からきている。
また、省略可能な場合はクエリパラメータの方が適している。
