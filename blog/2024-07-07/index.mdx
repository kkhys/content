---
title: Vercelビルド時にPlaywrightをインストールする
emoji: 🎭
category: Tech
tags: [Tips]
status: published
publishedAt: 2024-07-07
slug: b128uug
---

当ブログではシーケンス図やフローチャートの描画に [Mermaid](https://mermaid.js.org) を使用している。
変換方法として、MDXのビルド時にrehypeを使いJavaScriptオブジェクトに変換する処理の中で [rehype-mermaid](https://github.com/remcohaszing/rehype-mermaid) を使うことでMermaidに変換している。

https://kkhys.me/blog/posts/b1eemm6

rehype-mermaidがMermaidの構文をSVGにレンダリングする際にはヘッドレスブラウザの [Playwright](https://playwright.dev) を内部的に利用する。
このPlaywrightがなかなかの曲者である。

今回はVercelビルド時のNode.jsのバージョンを20にアップグレードする過程で詰まったので備忘録として残しておく。

## 開発環境

- Node.js: v20.15.0（Vercelではv20を指定）
- @playwright/test: v1.45.1

## Node18からNode20にアップグレードする

Vercelビルド時はNode.jsのバージョンを16, 18, 20の中から選べる。
デフォルトでは20になっているが、当プロジェクトではPlaywrightのインストールに失敗するため仕方なく18を使用していた。
ただ、基本的に最新のバージョンを使って運用したいので今回エラーの原因を調査することにしたというわけである。

Vercelビルド時のNode.jsのバージョンはVercelの管理画面から変更できるが`package.json`の`engines#node`を読み取ってオーバーライドする機能[^1]もあるためIaC的な考えから`package.json`に記載する方法がおすすめ。
そうすることで他の人がこのリポジトリをビルドするときにNode.jsのバージョンを合わせられるので一石二鳥だ。

[^1]: [Vercel: Version overrides in package.json](https://vercel.com/docs/functions/runtimes/node-js#version-overrides-in-package.json)

```json title="apps/web/package.json"
{
  "name": "@kkhys/web",
  // ...
  "engines": {
    "node": ">=20.15.0"
  },
  // ...
}
```

ちなみにNode.jsの他にパッケージマネージャのバージョンを指定したい場合は実験的な機能だが [Corepack](https://nodejs.org/docs/v20.15.0/api/corepack.html#corepack) を使うと良い。
Vercelでもサポートされている[^2]。

[^2]: [Vercel: Corepack](https://vercel.com/docs/deployments/configure-a-build#corepack)

```json title="package.json"
{
  "name": "root",
  // ...
  "packageManager": "pnpm@8.14.1",
  // ...
}
```

これで次回以降のビルドステップではNode20が使われるようになる（マイナーバージョン以下は自動的に決定される）。

## ビルド時にPlaywrightをインストールする

Vercelビルド時はTurborepoを使っている場合、デフォルトでは`turbo run build`が実行される。
そのコマンドが実行される前にPlaywrightをインストールしたいので、デフォルトの設定をオーバーライドするためにまずは以下のコードを追加する。

```json title="apps/web/package.json"
{
  "name": "@kkhys/web",
  // ...
  "scripts": {
    "playwright-install": "pnpx playwright-core install chromium",
  },
  // ...
}
```

`package.json`のscriptsフィールドに`playwright-install`というコマンドラインスクリプトを追加する。
このスクリプトを実行するとPlaywrightのコアライブラリを通じてChromiumブラウザバイナリをインストールする。

Playwrightの [公式ドキュメント](https://playwright.dev/docs/browsers#install-system-dependencies) にもあるとおり`--with-deps`を付ければPlaywrightの実行に必要なシステムの依存関係をインストールできるが、Vercelビルド時に使用するコンテナイメージが対応していないためこのオプションは使えない。
以下のエラーが発生する。

```text
sh: apt-get: command not found
Failed to install browsers
Error: Installation process exited with code: 127
ELIFECYCLE Command failed with exit code 1.
Error: Command "pnpm playwright-install && turbo run build" exited with 1
```

仕方なくオプションは付けずに進めていく（後で問題が起こるが）。

Vercelビルド時のビルドスクリプトをオーバーライドするにはVercelの管理画面から変更する方法と`vercel.json`で定義する方法がある。
可能な限りコードで環境を管理したいので`vercel.json`を使用していく。

```json title="vercel.json" showLineNumbers
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "buildCommand": "pnpm playwright-install && turbo run build"
}
```

`vercel.json`は [JSON Schema](https://json-schema.org) に対応しているため2行目で定義している。
JSON Schemaを使えばコードの補完が効くのでできれば設定しておきたい。

3行目で`package.json`に定義したスクリプトをビルドコマンドに追加する。
これをVercelにデプロイすればビルド時にPlaywrightがインストールされる。

## ビルドコンテナに追加のパッケージをインストールする

上述した設定を追加した上でVercelにデプロイすると以下のエラーが発生する。

```text
╔══════════════════════════════════════════════════════╗
║ Host system is missing dependencies to run browsers. ║
║ Please install them with the following command:      ║
║                                                      ║
║     pnpm exec playwright install-deps                ║
║                                                      ║
║ Alternatively, use apt:                              ║
║     apt-get install libnss3\                         ║
║         libnspr4\                                    ║
║         libgbm1                                      ║
║                                                      ║
║ <3 Playwright Team                                   ║
╚══════════════════════════════════════════════════════╝
```

Playwrightインストール時に`--with-deps`オプションを使えなかったのでそれが原因で実行に必要な依存関係が不足しているっぽい。
VercelはDockerデプロイに対応していないため万事休すかと思われたが、幸いにもインストールコマンドを使うことでビルドイメージにパッケージを追加できる[^3]。

[^3]: [Vercel: Installing additional packages](https://vercel.com/docs/deployments/build-image/build-image#installing-additional-packages)

ちなみにNode20ではベースイメージに [Amazon Linux 2023](https://aws.amazon.com/jp/linux/amazon-linux-2023) が使われている。
Amazon Linux 2023のパッケージマネージャはdnf（Dandified Yum）なので注意が必要（ただ、一応yumは使える）。

Vercelデプロイ時のエラーでは以下のパッケージを`apt-get`を使ってインストールするように言われたが、APTはDebianベースのパッケージマネージャなのでここでは`dnf install`を使うようにする。
システムによってパッケージ名が異なるのでそれぞれ置換する。

- libnss3 → nss
- libnspr4 → nspr
- libgbm1 → mesa-libgbm

念の為、ビルドイメージをローカル環境で実行して確かめてみる。

```bash
# Docker コンテナを作成して実行する
docker run --rm -it amazonlinux:2023.2.20231011.0 sh

# nss があるかチェック -> ある
dnf search nss

# nspr があるかチェック -> ある
dnf search nspr

# mesa-libgbm があるかチェック -> ある
dnf search mesa-libgbm

# それぞれインストールする
dnf install -y nss nspr mesa-libgbm

exit
```

問題なくインストールできたのでビルドコマンドと同じように`vercel.json`にインストールコマンドを追加する。

```diff lang="json" title="vercel.json"
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "buildCommand": "pnpm playwright-install && turbo run build",
+ "installCommand": "pnpm install && dnf install -y nss nspr mesa-libgbm"
}
```

これで完了。
Node20にアップグレードしてMermaidをSSGでレンダリングすることに成功した。

## さいごに

そもそもMermaidをレンダリングするためにわざわざヘッドレスブラウザをインストールするのはPlaywrightのサイズ的に考えてやり過ぎな気もするが、MermaidはNode.js上で動くDOMライブラリではレンダリングできないため仕方なく使っている[^4]。

[^4]: [GitHub Issue: server side mermaid with jsdom](https://github.com/mermaid-js/mermaid/issues/559)

Mermaidがjsdomに対応してくれれば良いのだがブラウザで使われることを想定されているためそうなることは当分の間なさそう。
ビルド時に毎回Playwrightをインストールするのは処理的に重いので、すでにPlaywrightをインストール済みの別環境でMermaidをレンダリングするAPIを作るなど他の方法がないか模索中である。
