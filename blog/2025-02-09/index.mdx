---
title: "v2.3.0 ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ: Cron ã§æ¯æ—¥è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"
description: SSG ã‚µã‚¤ãƒˆã§ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºé …ç›®ãŒå›ºå®šåŒ–ã•ã‚Œã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€Vercelã® Deploy Hook ã¨ Cron Jobs ã‚’æ´»ç”¨ã—ã¦æ¯æ—¥åˆå‰3æ™‚ã«è‡ªå‹•å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ãŸæ–¹æ³•ã§ã‚ã‚‹ã€‚
emoji: ğŸš€
category: Tech
tags: ["Release note"]
status: published
publishedAt: 2025-02-09
slug: b1x2lan
---

> [!WARNING]
> ã“ã®è¨˜äº‹ã¯ Next.js ç‰ˆã®å†…å®¹ã§ã™ã€‚ç¾åœ¨ã¯ Astro ã§æ§‹ç¯‰ã—ç›´ã—ãŸãŸã‚ã€æƒ…å ±ãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
> å½“æ™‚ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ [ã“ã¡ã‚‰](https://github.com/kkhys/me.v2) ã«ã‚ã‚‹ã®ã§å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

ã“ã®ã‚µã‚¤ãƒˆã¯åŸºæœ¬çš„ã« SSG ã§é™çš„ã«ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã€‚
ãã®ãŠã‹ã’ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ç›´æ¥ HTML ã‚’å±Šã‘ã‚‰ã‚Œã‚‹ãŸã‚ã€é«˜é€Ÿãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å¾—ã‚‰ã‚Œã‚‹ã€‚
ã—ã‹ã—ã€ãã®ä»£å„Ÿã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã•ã›ãŸã„é …ç›®ãŒã‚ã£ãŸã¨ã—ã¦ã‚‚ã€å†ãƒ“ãƒ«ãƒ‰ã—ãªã„é™ã‚Šæ°·æ¼¬ã‘ã®ã¾ã¾ã«ãªã£ã¦ã—ã¾ã†ã€‚

ã“ã®ã‚µã‚¤ãƒˆã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹é …ç›®ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

- ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰
- æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã®åˆæœŸè¡¨ç¤º
- è¨˜äº‹ä¸‹éƒ¨ã«ã‚ã‚‹é–¢é€£è¨˜äº‹

ä»Šã¯é »ç¹ã«æ›´æ–°ã—ã¦ã„ã‚‹ã®ã§å•é¡Œãªã„ãŒã€å¿™ã—ã•ã«é£²ã¿è¾¼ã¾ã‚ŒãŸæ—¥ã€…ãŒç¶šã‘ã°ã€ã‚µã‚¤ãƒˆãŒæ™‚é–“ã®ç‹­é–“ã«å–ã‚Šæ®‹ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚‚ååˆ†ã«ã‚ã‚‹ã€‚
ãã‚“ãªã‚±ãƒ¼ã‚¹ã‚’è¦‹è¶Šã—ã¦ã€æ¯æ—¥åˆå‰ 3 æ™‚ã«è‡ªå‹•ã§å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã€‚
ã¿ã‚“ãªãŒå¯é™ã¾ã£ã¦ã„ã‚‹ã“ã‚ã«ã²ã£ãã‚Šã¨ã‚µã‚¤ãƒˆã‚’æ›´æ–°ã•ã›ã‚‹ã€‚

## å®Ÿè£…æ–¹æ³•

1. Vercel ã® Deploy Hook ã‚’ä½œæˆã™ã‚‹
2. Vercel ã® Cron Jobs ã‚’ä½¿ã†
3. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã™ã‚‹ API ã‚’ä½œæˆã™ã‚‹

ã‚„ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ã€ã“ã® 3 ã‚¹ãƒ†ãƒƒãƒ—ã ã‘ã€‚

### Vercel ã® Deploy Hook ã‚’ä½œæˆã™ã‚‹

ã¾ãšã¯ Vercel ã®ç®¡ç†ç”»é¢ã‹ã‚‰ Deploy Hook ã‚’ä½œæˆã™ã‚‹ã€‚

https://vercel.com/docs/deployments/deploy-hooks

ã“ã® Deploy Hook ã® URL ã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã ã‘ã§ã€è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒèµ°ã‚‹ä»•çµ„ã¿ã§ã‚ã‚‹ã€‚
ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ CMS ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¤‰æ›´ã¨åŒæ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ç”¨é€”ã§ã‚‚æ´»ç”¨ã§ãã‚‹ã€‚

ãŸã ã—ã€ã“ã® URL ãŒæµå‡ºã™ã‚‹ã¨ã€èª°ã§ã‚‚å‹æ‰‹ã«å†ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã—ã¾ã†ã®ã§æ³¨æ„ãŒå¿…è¦ã€‚

> [!IMPORTANT]
> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€Cron ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°ãŒã•ã‚Œãªã„ã€‚
> eploy Hook URL ã®æœ«å°¾ã« `?buildCache=false` ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã§ãã‚‹ã€‚

### Vercel ã® Cron Jobs ã‚’è¨­å®šã™ã‚‹

æ¬¡ã«ã€Vercel ã® Cron Jobs ã‚’è¨­å®šã—ã¦ã€è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

https://vercel.com/docs/cron-jobs

`vercel.json` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’è¿½åŠ ã™ã‚Œã°ã€æŒ‡å®šã—ãŸæ™‚é–“ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

```json title="vercel.json"
{
  "crons": [
    {
      "path": "/api/cron/deploy",
      "schedule": "0 18 * * *"
    }
  ]
}
```

ã“ã“ã§æ³¨æ„ã™ã¹ãã¯ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãŒ UTCï¼ˆå”å®šä¸–ç•Œæ™‚ï¼‰ã§ã‚ã‚‹ã“ã¨ã€‚
JSTï¼ˆæ—¥æœ¬æ¨™æº–æ™‚ï¼‰ã§ æ¯æ—¥ 3 æ™‚ ã«å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€9 æ™‚é–“ãƒã‚¤ãƒŠã‚¹ã—ã¦ `0 18 * * *` ã¨ãªã‚‹ã€‚

ã¡ãªã¿ã« GitHub Actions ã§ã‚‚ Cron ã‚’è¨­å®šã™ã‚‹ã“ã¨ã¯å¯èƒ½ã€‚

https://docs.github.com/ja/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#schedule

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã™ã‚‹ API ã‚’ä½œæˆã™ã‚‹

ã‚ã¨ã¯ `/api/cron/deploy` ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸã¨ãã€Deploy Hook ã‚’å©ãå‡¦ç†ã‚’æ›¸ãã ã‘ã€‚

```ts title="apps/web/src/app/api/cron/deploy/route.ts" showLineNumbers
import { env } from "#/env";

const createResponse = (message: string, status: number) =>
  new Response(message, {
    status,
    headers: {
      "Content-Type": "text/plain",
      "X-Content-Type-Options": "nosniff",
    },
  });

export const GET = async (request: Request) => {
  const webhookUrl = env.VERCEL_DEPLOY_HOOK_URL;

  if (!webhookUrl) {
    return createResponse("Deploy hook URL is missing", 500);
  }

  const authHeader = request.headers.get("authorization");

  if (authHeader !== `Bearer ${env.CRON_SECRET}`) {
    return createResponse("Unauthorized", 401);
  }

  try {
    const response = await fetch(webhookUrl, { method: "POST" });

    if (response.ok) {
      return createResponse("Redeployment triggered", 200);
    }

    console.error(
      `Failed to trigger redeployment: ${response.status} ${response.statusText}`,
    );

    return createResponse("Failed to trigger redeployment", 500);
  } catch (error) {
    console.error("Error communicating with deploy hook", error);
    return createResponse("Error communicating with deploy hook", 500);
  }
};
```

ã“ã“ã§é‡è¦ãªã®ã¯ 21 è¡Œç›®ã§ã‚ã‚‹ã€‚
API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼ã‚’è¡Œã‚ãªã‘ã‚Œã°ã€èª°ã§ã‚‚ç„¡åˆ¶é™ã« API ã‚’å©ã‘ã¦ã—ã¾ã†ã€‚

ãã‚Œã¯å›°ã‚‹ã®ã§ã€Cron ç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆ`CRON_SECRET`ï¼‰ã‚’ä½¿ã„ã€æ­£ã—ã„èªè¨¼æƒ…å ±ã‚’æŒã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
å…·ä½“çš„ã«ã¯ã€`Authorization` ãƒ˜ãƒƒãƒ€ã‚’ `Bearer` ãƒˆãƒ¼ã‚¯ãƒ³ ã®å½¢ã§å—ã‘å–ã‚Šã€ãã‚ŒãŒç’°å¢ƒå¤‰æ•° `CRON_SECRET` ã¨ä¸€è‡´ã™ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚

ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€æ­£ã—ã„ `CRON_SECRET` ã‚’æŒã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã‘ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

### å®Ÿéš›ã«å‹•ãã‹ãƒ†ã‚¹ãƒˆ

å®Ÿè£…ã«å•é¡ŒãŒãªã„å ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã‘ã°ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ãŒèµ°ã‚Šå‡ºã™ã€‚

```shell
curl -X GET "https://xxx.com/api/cron/deploy" \
-H "Authorization: Bearer xxx"
```

### ã•ã„ã”ã«

ä½•ã§ã‚‚è‡ªå‹•ã§å‹•ãã®ã¯æœ€é«˜ã€‚
